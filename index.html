<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CR Gendarmerie</title>
<link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    background: #fff;
    color: #222;
  }
  h1,h2,h3 {
    text-align:center;
  }
  label {
    display: block;
    margin: 6px 0 3px 0;
  }
  input[type=text], input[type=date], input[type=time], select {
    width: 100%;
    padding: 6px 8px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #aaa;
    font-size: 1em;
  }
  button {
    cursor: pointer;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 1.1em;
    margin: 4px 2px;
    min-width: 36px;
    min-height: 36px;
    user-select:none;
    transition: background-color 0.2s ease;
  }
  button.plusminus {
    width: 48px;
    border-radius: 10px;
    font-size: 1.5em;
  }
  button.plusminus:hover {
    background-color: #ddd;
  }
  button.red {
    background-color: #d9534f;
    color: white;
    font-weight: bold;
  }
  button.red:hover {
    background-color: #c9302c;
  }
  button.blue {
    background-color: #3498db;
    color: white;
    font-weight: bold;
  }
  button.blue:hover {
    background-color: #217dbb;
  }
  .flex-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .flex-col {
    flex: 1 1 200px;
    min-width: 200px;
  }
  .vehicle-card {
    border: 2px solid #3498db;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 18px;
    background: #f9fafe;
  }
  .vehicle-card h3 {
    margin-top: 0;
    color: #2c3e50;
  }
  .number-input {
    width: 60px;
    font-size: 1.1em;
    text-align: center;
    border-radius: 4px;
    border: 1px solid #aaa;
    padding: 4px 6px;
  }
  .manual-input {
    width: 80px;
    font-size: 1em;
    padding: 4px 6px;
  }
  textarea {
    width: 100%;
    min-height: 80px;
    font-family: monospace;
    font-size: 1em;
    padding: 8px;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #ccc;
    resize: vertical;
  }
  hr {
    border: 0;
    border-top: 1.5px solid #ccc;
    margin: 18px 0;
  }
  .small-note {
    font-size: 0.85em;
    color: #666;
    margin-top: -6px;
    margin-bottom: 12px;
  }
  /* Responsive adjustments */
  @media (max-width: 768px) {
  .header-inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .header-inputs label {
    flex: 1 1 30%;
    font-size: 0.9em;
  }
  .header-inputs input {
    width: 100%;
    padding: 4px;
    font-size: 1em;
  
}
</style>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
<h1>CR Gendarmerie - LIMES Breil  La Turbie  DSI Tende</h1>

<section id="infosSection">
  <label for="siteSelect">Site :</label>
  <select id="siteSelect" aria-label="S√©lection du site">
    <option value="Breil">Breil</option>
    <option value="La Turbie">La Turbie</option>
    <option value="DSI Tende">DSI Tende</option>
  </select>

  <div class="flex-row" style="gap:15px; margin-top:10px;">
    <div class="flex-col">
      <label for="dateInput">Date :</label>
      <input type="date" id="dateInput" />
    </div>
    <div class="flex-col">
      <label for="heureDebutInput">Heure d√©but :</label>
      <input type="time" id="heureDebutInput" />
    </div>
    <div class="flex-col">
      <label for="heureFinInput">Heure fin :</label>
      <input type="time" id="heureFinInput" />
    </div>
  </div>
</section>

<hr/>

<section id="esrSection">
  <h2>ESR (Effectif)</h2>
  <div id="esrList"></div>
  <div style="margin-top:6px;">
    <input type="text" id="esrGrade" placeholder="Grade" />
    <input type="text" id="esrNom" placeholder="Nom Pr√©nom" />
    <input type="text" id="esrNigend" placeholder="Nigend" />
    <input type="text" id="esrCRT" placeholder="CRT ( ex: 06/1 Nice )" />
    <button id="addEsrBtn" class="blue">Ajouter ESR</button>
    <button id="delEsrBtn" class="red">Supprimer dernier ESR</button>
  </div>
  <div class="small-note">Tous les champs doivent √™tre remplis pour ajouter un ESR</div>
</section>

<hr/>

<section id="materielSection">
  <h2>Mat√©riel et utilisateurs</h2>
  <div class="flex-row" style="gap:12px;">
    <div style="flex:2;">
      <label>Cam√©ra n¬∞ :
        <input type="text" id="cameraNum" placeholder="Num√©ro  cam√©ra" />
      </label>
    </div>
    <div style="flex:3;">
      <label>Porteur cam√©ra (ESR) :
        <select id="cameraESR"></select>
      </label>
    </div>
  </div>
  <div class="flex-row" style="gap:12px;">
    <div style="flex:2;">
      <label>Tablette n¬∞ 1 :
        <input type="text" id="tablette1Num" placeholder="N¬∞(ex: 6)" />
      </label>
    </div>
    <div style="flex:3;">
      <label>Utilisateur tablette 1 (ESR) :
        <select id="tablette1ESR"></select>
      </label>
    </div>
  </div>
  <div class="flex-row" style="gap:12px;">
    <div style="flex:2;">
      <label>Tablette n¬∞ 2 (optionnel) :
        <input type="text" id="tablette2Num" placeholder="N¬∞(ex: 7)" />
      </label>
    </div>
    <div style="flex:3;">
      <label>Utilisateur tablette 2 (ESR) :
        <select id="tablette2ESR"></select>
      </label>
    </div>
  </div>
  <div style="margin-top:12px;">
    <label>V√©hicule de service (immatriculation) :
      <input type="text" id="vehiculeService" placeholder="Ex: AB-123-CD" />
    </label>
  </div>
</section>

<hr/>

<section id="vehiculesSection">
  <h2>Moyens / Personnes contr√¥l√©es</h2>

  <div class="vehicle-card" id="trainCard">
    <h3>Train</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="train" data-field="vehicles" data-action="minus">-</button>
        <span id="trainVehiclesCount">0</span> v√©hicules
        <button class="plusminus" data-type="train" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="train" data-field="cv" data-action="minus">-</button>
        <span id="trainCvCount">0</span> CV
        <button class="plusminus" data-type="train" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
          <input type="number" id="trainCvManual" class="manual-input" min="0" value="0" />
          <button id="trainCvAddManualBtn">Ajouter</button>
        </label>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="train" data-field="cf" data-action="minus">-</button>
        <span id="trainCfCount">0</span> CF
        <button class="plusminus" data-type="train" data-field="cf" data-action="plus">+</button>
      </div>
    </div>
  </div>

  <div class="vehicle-card" id="busCard">
    <h3>Bus</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="bus" data-field="vehicles" data-action="minus">-</button>
        <span id="busVehiclesCount">0</span> v√©hicules
        <button class="plusminus" data-type="bus" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="bus" data-field="cv" data-action="minus">-</button>
        <span id="busCvCount">0</span> CV
        <button class="plusminus" data-type="bus" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
          <input type="number" id="busCvManual" class="manual-input" min="0" value="0" />
          <button id="busCvAddManualBtn">Ajouter</button>
        </label>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="bus" data-field="cf" data-action="minus">-</button>
        <span id="busCfCount">0</span> CF
        <button class="plusminus" data-type="bus" data-field="cf" data-action="plus">+</button>
      </div>
    </div>
  </div>

  <div class="vehicle-card" id="vlCard">
    <h3>VL</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="vl" data-field="vehicles" data-action="minus">-</button>
        <span id="vlVehiclesCount">0</span> v√©hicules
        <button class="plusminus" data-type="vl" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="vl" data-field="cv" data-action="minus">-</button>
        <span id="vlCvCount">0</span> CV
        <button class="plusminus" data-type="vl" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
        <input type="number" id="vlCvManual" class="manual-input" min="0" value="0" />
        <button id="vlCvAddManualBtn">Ajouter</button>
      </label>
    </div>
    <div style="margin-left:20px;">
        <button class="plusminus" data-type="vl" data-field="cf" data-action="minus">-</button>
        <span id="vlCfCount">0</span> CF
        <button class="plusminus" data-type="vl" data-field="cf" data-action="plus">+</button>
      </div>
    </div>
  </div>

  <div class="vehicle-card" id="plCard">
    <h3>PL</h3>
    <div class="flex-row" style="align-items:center;">
      <div>
        <button class="plusminus" data-type="pl" data-field="vehicles" data-action="minus">-</button>
        <span id="plVehiclesCount">0</span> v√©hicules
        <button class="plusminus" data-type="pl" data-field="vehicles" data-action="plus">+</button>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="pl" data-field="cv" data-action="minus">-</button>
        <span id="plCvCount">0</span> CV
        <button class="plusminus" data-type="pl" data-field="cv" data-action="plus">+</button>
      </div>
      <div>
        <label style="margin-left:15px;">Ajouter CV manuellement:
        <input type="number" id="plCvManual" class="manual-input" min="0" value="0" />
        <button id="plCvAddManualBtn">Ajouter</button>
      </label>
      </div>
      <div style="margin-left:20px;">
        <button class="plusminus" data-type="pl" data-field="cf" data-action="minus">-</button>
        <span id="plCfCount">0</span> CF
        <button class="plusminus" data-type="pl" data-field="cf" data-action="plus">+</button>
      </div>
    </div>
  </div>
</section>

<hr/>

<section id="esiSection">
  <h2>ESI Intercept√©(s)</h2>
  <div id="esiList"></div>
  <div style="margin-top:6px;">
    <select id="esiAge" aria-label="Majeur ou mineur">
      <option value="">Majeur(e)/Mineur(e)</option>
      <option value="Majeur">Majeur</option>
      <option value="Mineur">Mineur</option>
      <option value="Majeure">Majeure</option>
      <option value="Mineure">Mineure</option>
    </select>
    <select id="esiSexe" aria-label="Sexe H/F">
      <option value="">Homme/Femme</option>
      <option value="Homme">Homme</option>
      <option value="Femme">Femme</option>
    </select>
    <input type="number" id="esiAgeNum" placeholder="√Çge (chiffre)" min="0" style="width: 100px;" />
    <input type="text" id="esiNationalite" placeholder="Nationalit√©" />
    <input type="text" id="esiLieu" placeholder="Lieu interpellation" />
    <label for="esiHeure">Heure interpellation :</label>
<input type="time" id="esiHeure" />
    <input type="text" id="esiSuites" placeholder="Suites donn√©es" />
    <button id="addEsiBtn" class="blue">Ajouter ESI</button>
    <button id="delEsiBtn" class="red">Supprimer dernier ESI</button>
  </div>
  <div class="small-note">Tous les champs doivent √™tre remplis pour ajouter un ESI</div>
</section>

<hr/>

<section id="passeurSection">
  <h2>Passeur(s) Intercept√©(s)</h2>
  <div id="passeurList"></div>
  <div style="margin-top:6px;">
    <select id="passeurAge" aria-label="Majeur ou mineur">
      <option value="">Majeur(e)/Mineur(e)</option>
      <option value="Majeur">Majeur</option>
      <option value="Mineur">Mineur</option>
      <option value="Majeure">Majeure</option>
      <option value="Mineure">Mineure</option>
    </select>
    <select id="passeurSexe" aria-label="Sexe H/F">
      <option value="">Homme/Femme</option>
      <option value="Homme">Homme</option>
      <option value="Femme">Femme</option>
    </select>
    <input type="number" id="passeurAgeNum" placeholder="√Çge (chiffre)" min="0" style="width: 100px;" />
    <input type="text" id="passeurNationalite" placeholder="Nationalit√©" />
    <input type="text" id="passeurLieu" placeholder="Lieu interpellation" />
    <label for="passeurHeure">Heure interpellation :</label>
<input type="time" id="passeurHeure" />
    <input type="text" id="passeurSuites" placeholder="Suites donn√©es" />
    <button id="addPasseurBtn" class="blue">Ajouter Passeur</button>
    <button id="delPasseurBtn" class="red">Suppr. dernier Passeur</button>
  </div>
  <div class="small-note">Tous les champs doivent √™tre remplis pour ajouter un passeur</div>
</section>

<hr/>

<section id="observationsSection">
  <h2>Observations</h2>
  <textarea id="observations" placeholder="Difficult√©s √©ventuelles (tablette, t√©l√©phone, v√©hicule, ...)&#10;Autres‚Ä¶"></textarea>
</section>

<hr/>

<section id="deroulementSection">
  <h2>D√©roulement de la mission</h2>
  <textarea id="deroulement" placeholder="..."></textarea>
</section>

<hr/>

<section id="pulsarSection">
  <h2>PULSAR</h2>
  <label>
    <input type="radio" name="pulsar" id="pulsarOui" value="oui"> Oui
  </label>
  <label>
    <input type="radio" name="pulsar" id="pulsarNon" value="non"> Non
  </label>
</section>

<hr/>

<section style="text-align:center; margin-bottom: 20px;">
  <button id="generateBtn" style="background-color:#3498db; color:white; font-weight:bold; padding: 10px 20px; font-size:1.2em;">G√©n√©rer compte rendu</button>
  <button id="copyBtn" style="background-color:#27ae60; color:white; font-weight:bold; padding: 10px 20px; font-size:1.2em;">Copier dans le presse-papiers</button>
  <button id="resetBtn" class="red" style="font-size:1.2em;">Effacer les donn√©es sauvegard√©es</button>
  <button id="scanQrBtn">üì∑ Scanner QR Code</button>
  <button id="stopQrBtn">‚úñÔ∏è Arr√™ter le scan</button>
  <div id="qr-reader" style="width: 300px; display: none;"></div>
</section>

<section>
<label>R√©sum√© des ESR</label>
<textarea id="esrSummary" readonly style="width:100%; height:80px; margin-bottom:10px;"></textarea>
<section>

<section>
  <h2>Compte rendu g√©n√©r√© :</h2>
  <textarea id="compteRendu" readonly rows="20" style="font-family: monospace; white-space: pre-wrap;"></textarea>
</section>

<script>
  (() => {
    // Donn√©es initiales
    const state = {
      site: '',
      date: '',
      heureDebut: '',
      heureFin: '',
      esrList: [],
      cameraNum: '',
      cameraESR: '',
      tablette1Num: '',
      tablette1ESR: '',
      tablette2Num: '',
      tablette2ESR: '',
      vehiculeService: '',
      vehicules: { train: 0, bus: 0, vl: 0, pl: 0 },
      cv: { train: 0, bus: 0, vl: 0, pl: 0 },
      cf: { train: 0, bus: 0, vl: 0, pl: 0 },
      esiList: [],
      passeurList: [],
      observations: '',
      deroulement: '',
      pulsar: '',
    };

    // Debounce pour sauvegarde auto
    let saveTimeout = null;
    function debounceSave() {
      if(saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        saveToStorage();
        //console.log('Donn√©es sauvegard√©es automatiquement');
      }, 3000);
    }

    // Sauvegarde dans localStorage
    function saveToStorage() {
      localStorage.setItem('crGendarmerie', JSON.stringify(state));
    }

    // Chargement depuis localStorage
    function loadFromStorage() {
      const data = localStorage.getItem('crGendarmerie');
      if(data) {
        const parsed = JSON.parse(data);
        Object.assign(state, parsed);
      }
    }

    // Mise √† jour de la page depuis state
    function updateUI() {
      document.getElementById('siteSelect').value = state.site;
      document.getElementById('dateInput').value = state.date;
      document.getElementById('heureDebutInput').value = state.heureDebut;
      document.getElementById('heureFinInput').value = state.heureFin;
      // ESR
      renderEsrList();
      // Mat√©riel
      document.getElementById('cameraNum').value = state.cameraNum;
      document.getElementById('tablette1Num').value = state.tablette1Num;
      document.getElementById('tablette2Num').value = state.tablette2Num;
      document.getElementById('vehiculeService').value = state.vehiculeService;
      // Mise √† jour listes ESR pour s√©lection mat√©riel
      populateEsrSelects();

      // Mat√©riel ESR s√©lectionn√©
      document.getElementById('cameraESR').value = state.cameraESR;
      document.getElementById('tablette1ESR').value = state.tablette1ESR;
      document.getElementById('tablette2ESR').value = state.tablette2ESR;

      // V√©hicules / personnes
      ['train','bus','vl','pl'].forEach(type => {
        document.getElementById(type+'VehiclesCount').textContent = state.vehicules[type];
        document.getElementById(type+'CvCount').textContent = state.cv[type];
        document.getElementById(type+'CfCount').textContent = state.cf[type];
      });

      // ESI
      renderEsiList();

      // Passeur
      renderPasseurList();

      // Observations & d√©roulement
      document.getElementById('observations').value = state.observations;
      document.getElementById('deroulement').value = state.deroulement;
    }

    // Rendu liste ESR
    function renderEsrList() {
      const container = document.getElementById('esrList');
      container.innerHTML = '';
      if(state.esrList.length === 0) {
        container.textContent = 'Aucun ESR ajout√©.';
        return;
      }
      const ul = document.createElement('ul');
      state.esrList.forEach((esr,i) => {
        const li = document.createElement('li');
        li.textContent = `${i+1} - ${esr.grade} ${esr.nom} - ${esr.nigend} - ${esr.crt}`;
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }

    // Ajout ESR si valide
    function addEsr() {
      const grade = document.getElementById('esrGrade').value.trim();
      const nom = document.getElementById('esrNom').value.trim();
      const nigend = document.getElementById('esrNigend').value.trim();
      const crt = document.getElementById('esrCRT').value.trim();
      if(!grade || !nom || !nigend || !crt) {
        alert('Merci de remplir tous les champs ESR.');
        return;
      }
      state.esrList.push({grade, nom, nigend, crt});
      // reset champs
      document.getElementById('esrGrade').value = '';
      document.getElementById('esrNom').value = '';
      document.getElementById('esrNigend').value = '';
      document.getElementById('esrCRT').value = '';
      populateEsrSelects();
      renderEsrList();
      debounceSave();
    }

    // Supprimer dernier ESR
    function delEsr() {
      if(state.esrList.length > 0) {
        state.esrList.pop();
        populateEsrSelects();
        renderEsrList();
        debounceSave();
      }
    }

    // Remplissage des selects ESR mat√©riel
    function populateEsrSelects() {
      ['cameraESR','tablette1ESR','tablette2ESR'].forEach(id => {
        const sel = document.getElementById(id);
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">--</option>';
        state.esrList.forEach((esr,i) => {
          const opt = document.createElement('option');
          opt.value = `${esr.grade} ${esr.nom}`;
          opt.textContent = `${esr.grade} ${esr.nom}`;
          sel.appendChild(opt);
        });
        if([...sel.options].some(o => o.value === currentVal)) {
          sel.value = currentVal;
        } else {
          sel.value = '';
        }
      });
    }

    // Gestion boutons plus / moins
    function changeCount(type, field, action) {
      if(!state.vehicules[type]) state.vehicules[type] = 0;
      if(!state.cv[type]) state.cv[type] = 0;
      if(!state.cf[type]) state.cf[type] = 0;
      if(field === 'vehicles') {
        if(action === 'plus') state.vehicules[type]++;
        else if(action === 'minus' && state.vehicules[type] > 0) state.vehicules[type]--;
      } else if(field === 'cv') {
        if(action === 'plus') state.cv[type]++;
        else if(action === 'minus' && state.cv[type] > 0) state.cv[type]--;
      } else if(field === 'cf') {
        if(action === 'plus') state.cf[type]++;
        else if(action === 'minus' && state.cf[type] > 0) state.cf[type]--;
      }
      updateUI();
      debounceSave();
    }

    // Ajouter manuel CV bus/train
    function addManualCv(type) {
      const input = document.getElementById(type+'CvManual');
      const val = parseInt(input.value);
      if(isNaN(val) || val < 1) {
        alert('Veuillez saisir un nombre entier sup√©rieur √† 0.');
        return;
      }
      state.cv[type] += val;
      input.value = 0;
      updateUI();
      debounceSave();
    }

    // Rendu liste ESI
    function renderEsiList() {
      const container = document.getElementById('esiList');
      container.innerHTML = '';
      if(state.esiList.length === 0) {
        container.textContent = 'Aucun ESI ajout√©.';
        return;
      }
      const ul = document.createElement('ul');
      state.esiList.forEach((esi,i) => {
        const li = document.createElement('li');
        li.textContent = `${i+1} - ${esi.heure} - ${esi.age} - ${esi.sexe} - ${esi.ageNum} ans - ${esi.nationalite} - ${esi.lieu} - ${esi.suites}`;
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }

    // Ajouter ESI valide
    function addEsi() {
      const heure = document.getElementById('esiHeure').value.trim();
      const age = document.getElementById('esiAge').value;
      const sexe = document.getElementById('esiSexe').value;
      const ageNum = document.getElementById('esiAgeNum').value.trim();
      const nationalite = document.getElementById('esiNationalite').value.trim();
      const lieu = document.getElementById('esiLieu').value.trim();
      const suites = document.getElementById('esiSuites').value.trim();
      if(!age || !sexe || !ageNum || !nationalite || !lieu || !suites) {
        alert('Merci de remplir tous les champs ESI.');
        return;
      }
      state.esiList.push({age,sexe,ageNum,nationalite,lieu,heure,suites});
      // Reset champs
      document.getElementById('esiAge').value = '';
      document.getElementById('esiSexe').value = '';
      document.getElementById('esiAgeNum').value = '';
      document.getElementById('esiNationalite').value = '';
      document.getElementById('esiLieu').value = '';
      document.getElementById('esiSuites').value = '';
      document.getElementById('esiHeure').value = '';
      renderEsiList();
      debounceSave();
    }

    // Supprimer dernier ESI
    function delEsi() {
      if(state.esiList.length > 0) {
        state.esiList.pop();
        renderEsiList();
        debounceSave();
      }
    }

    // Rendu liste passeur
    function renderPasseurList() {
      const container = document.getElementById('passeurList');
      container.innerHTML = '';
      if(state.passeurList.length === 0) {
        container.textContent = 'Aucun passeur ajout√©.';
        return;
      }
      const ul = document.createElement('ul');
      state.passeurList.forEach((passeur,i) => {
        const li = document.createElement('li');
        li.textContent = `${i+1} - ${passeur.heure} - ${passeur.age} - ${passeur.sexe} - ${passeur.ageNum} ans - ${passeur.nationalite} - ${passeur.lieu} - ${passeur.suites}`;
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }

    // Ajouter passeur valide
    function addPasseur() {
      const heure = document.getElementById('passeurHeure').value.trim();
      const age = document.getElementById('passeurAge').value;
      const sexe = document.getElementById('passeurSexe').value;
      const ageNum = document.getElementById('passeurAgeNum').value.trim();
      const nationalite = document.getElementById('passeurNationalite').value.trim();
      const lieu = document.getElementById('passeurLieu').value.trim();
      const suites = document.getElementById('passeurSuites').value.trim();
      if(!age || !sexe || !ageNum || !nationalite || !lieu || !suites) {
        alert('Merci de remplir tous les champs Passeur.');
        return;
      }
      state.passeurList.push({age,sexe,ageNum,nationalite,lieu,heure,suites});
      // Reset champs
      document.getElementById('passeurAge').value = '';
      document.getElementById('passeurSexe').value = '';
      document.getElementById('passeurAgeNum').value = '';
      document.getElementById('passeurNationalite').value = '';
      document.getElementById('passeurHeure').value = '';
      document.getElementById('passeurLieu').value = '';
      document.getElementById('passeurSuites').value = '';
      renderPasseurList();
      debounceSave();
    }

    // Supprimer dernier passeur
    function delPasseur() {
      if(state.passeurList.length > 0) {
        state.passeurList.pop();
        renderPasseurList();
        debounceSave();
      }
    }

    // G√©n√©re le compte rendu final
    function generateCompteRendu() {
      if(!state.date) {
        alert('Merci de s√©lectionner une date.');
        return;
      }
      const site = state.site;
      const date = state.date.split('-').reverse().join('/');
      const heureDebut = state.heureDebut || '';
      const heureFin = state.heureFin || '';
      const esrCount = state.esrList.length;

      let cr = `LIMES ${site} - CR - ${date} - ${heureDebut} √† ${heureFin}\n\n`;

      cr += `(${esrCount}) ESR\n`;
      state.esrList.forEach((esr,i) => {
        cr += `${i+1} ${esr.grade} - ${esr.nom} - ${esr.nigend} - CRT ${esr.crt}\n`;
      });

      cr += `\nPorteur cam√©ra n¬∫ ${state.cameraNum} : ${state.cameraESR || ''}\n`;
      cr += `Tablette n¬∫ T${state.tablette1Num} : ${state.tablette1ESR || ''}\n`;
      if(state.tablette2Num.trim() !== '') {
        cr += `Tablette n¬∫ T${state.tablette2Num} : ${state.tablette2ESR || ''}\n`;
      }
      if(state.vehiculeService.trim() !== '') {
        cr += `V√©hicule de service : ${state.vehiculeService}\n`;
      }

      cr += `\n1 - MOYENS / PERSONNES:\n`;
      ['train','bus','vl','pl'].forEach(type => {
        const vCount = state.vehicules[type];
        const cvCount = state.cv[type];
        const cfCount = state.cf[type];
        cr += `- ${type.charAt(0).toUpperCase() + type.slice(1)}: ${vCount} / ${cvCount} CV / ${cfCount} CF\n`;
      });

      const totalVehicules = ['train','bus','vl','pl'].reduce((a,t) => a + state.vehicules[t], 0);
      const totalPersonnes = ['train','bus','vl','pl'].reduce((a,t) => a + state.cv[t] + state.cf[t], 0);
      cr += `\nTOTAL MOYENS : ${totalVehicules}\n`;
      cr += `TOTAL PERSONNES : ${totalPersonnes}\n`;

      cr += `\n2 - ESI INTERCEPT√â(S): ${state.esiList.length}\n`;
state.esiList.forEach((esi,i) => {
  cr += `ESI ${i+1} - ${esi.heure} - ${esi.age} - ${esi.sexe} - ${esi.ageNum} ans - ${esi.nationalite} - ${esi.lieu} - ${esi.suites}\n`;
});

cr += `\n3 - PASSEUR(S) INTERCEPT√â(S): ${state.passeurList.length}\n`;
state.passeurList.forEach((passeur,i) => {
  cr += `PASSEUR ${i+1} - ${passeur.heure} - ${passeur.age} - ${passeur.sexe} - ${passeur.ageNum} ans - ${passeur.nationalite} - ${passeur.lieu} - ${passeur.suites}\n`;
});

      cr += `\n4 - OBSERVATIONS\n${state.observations.trim() || '(Aucune)'}\n`;
      cr += `\n5 - D√âROULEMENT DE LA MISSION\n${state.deroulement.trim() || '(Aucun d√©tail)'}\n`;
     if(state.pulsar === 'oui') {
  cr += `\n6 - PULSAR fait\n`;
} else if(state.pulsar === 'non') {
  cr += `\n6 - PULSAR non fait\n`;
} else {
  cr += `\n6 - PULSAR (non renseign√©)\n`;
}

      document.getElementById('compteRendu').value = cr;
    }

    // Copier le CR dans le presse-papiers
    function copyToClipboard() {
      const textarea = document.getElementById('compteRendu');
      if(!textarea.value) {
        alert('G√©n√©rez d‚Äôabord le compte rendu.');
        return;
      }
      textarea.select();
      textarea.setSelectionRange(0, 99999);
      try {
        navigator.clipboard.writeText(textarea.value)
          .then(() => alert('Compte rendu copi√© dans le presse-papiers !'))
          .catch(() => fallbackCopy(textarea));
      } catch {
        fallbackCopy(textarea);
      }
    }
    // Fallback pour anciens navigateurs
    function fallbackCopy(textarea) {
      try {
        const successful = document.execCommand('copy');
        if(successful) alert('Compte rendu copi√© dans le presse-papiers !');
        else alert('Impossible de copier. S√©lectionnez manuellement le texte.');
      } catch {
        alert('Impossible de copier. S√©lectionnez manuellement le texte.');
      }
    }

    // Reset / effacer donn√©es sauvegard√©es
    function resetData() {
      if(confirm('Voulez-vous vraiment effacer toutes les donn√©es sauvegard√©es ?')) {
        localStorage.removeItem('crGendarmerie');
        location.reload();
      }
    }

    // Mise √† jour √©tat lors modification champs g√©n√©raux
    function onGeneralChange() {
      state.site = document.getElementById('siteSelect').value;
      state.date = document.getElementById('dateInput').value;
      state.heureDebut = document.getElementById('heureDebutInput').value;
      state.heureFin = document.getElementById('heureFinInput').value;
      debounceSave();
    }
    // Mise √† jour mat√©riel
    function onMaterielChange() {
      state.cameraNum = document.getElementById('cameraNum').value.trim();
      state.cameraESR = document.getElementById('cameraESR').value;
      state.tablette1Num = document.getElementById('tablette1Num').value.trim();
      state.tablette1ESR = document.getElementById('tablette1ESR').value;
      state.tablette2Num = document.getElementById('tablette2Num').value.trim();
      state.tablette2ESR = document.getElementById('tablette2ESR').value;
      state.vehiculeService = document.getElementById('vehiculeService').value.trim();
      debounceSave();
    }

    // Mise √† jour observations et d√©roulement
    function onTextAreaChange() {
      state.observations = document.getElementById('observations').value;
      state.deroulement = document.getElementById('deroulement').value;
      debounceSave();
    }

     function onPulsarChange() {
  if(document.getElementById('pulsarOui').checked) {
    state.pulsar = 'oui';
  } else if(document.getElementById('pulsarNon').checked) {
    state.pulsar = 'non';
  } else {
    state.pulsar = '';
  }
  debounceSave();
}

    // Initialisation
    function init() {
      loadFromStorage();
      updateUI();

      // Events ESR
      document.getElementById('addEsrBtn').addEventListener('click', addEsr);
      document.getElementById('delEsrBtn').addEventListener('click', delEsr);

      // Events ESI
      document.getElementById('addEsiBtn').addEventListener('click', addEsi);
      document.getElementById('delEsiBtn').addEventListener('click', delEsi);

      // Events Passeur
      document.getElementById('addPasseurBtn').addEventListener('click', addPasseur);
      document.getElementById('delPasseurBtn').addEventListener('click', delPasseur);

      // Events boutons plus / moins v√©hicules / cv / cf
      document.querySelectorAll('button.plusminus').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const t = e.target;
          changeCount(t.dataset.type, t.dataset.field, t.dataset.action);
        });
      });

      // Ajout manuel CV bus/train
      document.getElementById('trainCvAddManualBtn').addEventListener('click', () => addManualCv('train'));
      document.getElementById('busCvAddManualBtn').addEventListener('click', () => addManualCv('bus'));
      document.getElementById('vlCvAddManualBtn').addEventListener('click', () => addManualCv('vl'));
      document.getElementById('plCvAddManualBtn').addEventListener('click', () => addManualCv('pl'));

      // Champs g√©n√©raux
      ['siteSelect','dateInput','heureDebutInput','heureFinInput'].forEach(id => {
        document.getElementById(id).addEventListener('input', onGeneralChange);
      });

      // Mat√©riel
      ['cameraNum','cameraESR','tablette1Num','tablette1ESR','tablette2Num','tablette2ESR','vehiculeService'].forEach(id => {
        document.getElementById(id).addEventListener('input', onMaterielChange);
      });

      // Observations & d√©roulement
      ['observations','deroulement'].forEach(id => {
        document.getElementById(id).addEventListener('input', onTextAreaChange);
      });

      // Boutons g√©n√©rer / copier / reset
      document.getElementById('generateBtn').addEventListener('click', generateCompteRendu);
      document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
      document.getElementById('resetBtn').addEventListener('click', resetData);
    }

    document.getElementById('pulsarOui').addEventListener('change', onPulsarChange);
document.getElementById('pulsarNon').addEventListener('change', onPulsarChange);

if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log("Service Worker enregistr√©"))
        .catch(err => console.error("Erreur SW:", err));
     }

document.getElementById("scanQrBtn").addEventListener("click", () => {
    const qrCodeData = prompt("Collez le QR code ici"); // simple prompt pour simuler le scan
    if (!qrCodeData) return;

    safeProcessQRCode(qrCodeData);
});

function safeProcessQRCode(qrData) {
    // V√©rifier que le QR code contient un NIGEND
    const nigendMatch = qrData.match(/NIGEND\s*:\s*(\d+)/i);
    if (!nigendMatch) {
        alert("QR code invalide : NIGEND non trouv√©");
        return;
    }
    const nigend = nigendMatch[1];

    if (scannedNigends.includes(nigend)) {
        alert("Ce QR code a d√©j√† √©t√© scann√©");
        return;
    }

    scannedNigends.push(nigend);
    processQRCode(qrData); // ta fonction existante qui va transformer les donn√©es en tableau

    updateESRSummary();
}

function updateESRSummary() {
    // Additionner les donn√©es de tous les QR codes scann√©s et afficher dans le r√©sum√© ESR
    let totalTrainCV = 0, totalTrainCF = 0;
    let totalBusCV = 0, totalBusCF = 0;
    let totalVlCV = 0, totalVlCF = 0;
    let totalPlCV = 0, totalPlCF = 0;

    scannedNigends.forEach(n => {
        const data = JSON.parse(localStorage.getItem("crGendarmerie_" + n)); // on stockera chaque QR code s√©par√©ment
        if (!data) return;

        totalTrainCV += data.trainCV || 0;
        totalTrainCF += data.trainCF || 0;
        totalBusCV += data.busCV || 0;
        totalBusCF += data.busCF || 0;
        totalVlCV += data.vlCV || 0;
        totalVlCF += data.vlCF || 0;
        totalPlCV += data.plCV || 0;
        totalPlCF += data.plCF || 0;
    });

    const totalMoyens = (totalTrainCV+totalTrainCF)+(totalBusCV+totalBusCF)+(totalVlCV+totalVlCF)+(totalPlCV+totalPlCF);
    const totalPersonnes = totalTrainCV+totalTrainCF+totalBusCV+totalBusCF+totalVlCV+totalVlCF+totalPlCV+totalPlCF;

    document.getElementById("esrSummary").value = 
`MOYENS / PERSONNES:
- Train: ${totalTrainCV + totalTrainCF} CV / ${totalTrainCF} CF
- Bus: ${totalBusCV + totalBusCF} CV / ${totalBusCF} CF
- Vl: ${totalVlCV + totalVlCF} CV / ${totalVlCF} CF
- Pl: ${totalPlCV + totalPlCF} CV / ${totalPlCF} CF

TOTAL MOYENS : ${totalMoyens}
TOTAL PERSONNES : ${totalPersonnes}`;
}
    // =======================
    //   QR CODE INTEGRATION
    // =======================

    let scannedNigends = []; // Pour √©viter les doublons

    // Fonction qui traite le texte du QR
    function processQrData(qrText) {
      const lines = qrText.split("\n").map(l => l.trim()).filter(l => l !== "");

      // V√©rifier pr√©sence du NIGEND
      const nigendLine = lines.find(l => l.startsWith("NIGEND"));
      if (!nigendLine) {
        alert("QR code invalide : NIGEND manquant");
        return;
      }
      const nigend = nigendLine.split(":")[1].trim();

      // V√©rifier si d√©j√† scann√©
      if (scannedNigends.includes(nigend)) {
        alert("QR code d√©j√† scann√© !");
        return;
      }
      scannedNigends.push(nigend);

      // Ajouter le texte brut dans R√©sum√© ESR
      const summaryArea = document.getElementById("esrSummary");
      summaryArea.value += qrText + "\n\n";

      // Extraire les lignes Train/Bus/VL/PL
      ["Train","Bus","Vl","Pl"].forEach(type => {
        const line = lines.find(l => l.startsWith(type));
        if (line) {
          const match = line.match(/(\d+)\s*\/\s*(\d+)\s*CV\s*\/\s*(\d+)\s*CF/);
          if (match) {
            const veh = parseInt(match[1]);
            const cv = parseInt(match[2]);
            const cf = parseInt(match[3]);
            const key = type.toLowerCase();
            state.vehicules[key] += veh;
            state.cv[key] += cv;
            state.cf[key] += cf;
          }
        }
      });

      updateUI();
      debounceSave();
    }

    // Callback quand un QR est scann√©
    function qrCodeSuccessCallback(decodedText, decodedResult) {
      processQrData(decodedText);
      html5QrCode.stop().then(() => {
        document.getElementById("qr-reader").remove();
      });
    }

    // Lancer la cam√©ra quand on clique sur "Scanner QR code"
    document.getElementById("scanQrBtn").addEventListener("click", () => {
      if (document.getElementById("qr-reader")) return; // √©viter doublons

      const qrReader = document.createElement("div");
      qrReader.id = "qr-reader";
      qrReader.style.width = "100%";
      qrReader.style.margin = "10px auto";
      document.body.insertBefore(qrReader, document.getElementById("compteRendu"));

      const html5QrCode = new Html5Qrcode("qr-reader");
      const config = { fps: 10, qrbox: 250, facingMode: "environment" };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeSuccessCallback
      ).catch(err => {
        alert("Impossible d'acc√©der √† la cam√©ra : " + err);
      });
    });
let html5QrCode; // variable globale pour le scanner

document.getElementById("scanQrBtn").addEventListener("click", () => {
  startQRScanner();
});

document.getElementById("stopQrBtn").addEventListener("click", () => {
  stopQRScanner();
});

function startQRScanner() {
  document.getElementById("qr-reader").style.display = "block";
  html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode.start(
    { facingMode: "environment" },  // cam√©ra arri√®re par d√©faut
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      safeProcessQRCode(decodedText); 
      // ‚ö†Ô∏è on ne coupe pas le scanner automatiquement ici
      // tu peux donc scanner plusieurs QR √† la suite
    }
  ).catch(err => {
    console.error("Erreur d√©marrage scanner:", err);
  });
}

function stopQRScanner() {
  if (html5QrCode) {
    html5QrCode.stop().then(() => {
      console.log("Scanner arr√™t√©");
      document.getElementById("qr-reader").style.display = "none";
    }).catch(err => {
      console.error("Erreur arr√™t scanner:", err);
    });
  }
}


    // Initialiser la page
    init();
  })();
</script>
</body>
</html>